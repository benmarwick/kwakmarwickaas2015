---
title: "Figures for 'Food processing and pottery use in the Early Bronze Age, Central Korean Peninsula'"
author: "Ben Marwick & Seunkgi Kwak"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This document reproduces the figures illustrating the geochemical data in Kwak and Marwick 'Food processing and pottery use in the Early Bronze Age, Central Korean Peninsula'

```{r}
library(kwakmarwick2015)
knitr::opts_chunk$set(cache = TRUE)
```

## Figures

The density distribution of the radiocarbon dates from the two sites.

```{r  results='hide'}
# read data in, three columns Name = lab code, Date = radiocarbon age, Uncertainty =  error
dates_KM <- read.csv('data/radiocarbon_KM.csv', stringsAsFactors = FALSE)
dates_SS <- read.csv('data/radiocarbon_SS.csv', stringsAsFactors = FALSE)

# make date names
dates_KM$Name <- paste0("KM_", dates_KM[,1])
dates_SS$Name <- paste0("SS_", dates_SS[,1])
# remove spaces
dates_KM$Name <- gsub("[[:space:]]", "_", dates_KM$Name)
dates_SS$Name <- gsub("[[:space:]]", "_", dates_SS$Name)

# split age and error term
library(stringr)

# KM
date_split  <- str_split_fixed(dates_KM$C14.date..BP..uncalibrated., "pm", 2)
date_split_Age <- as.numeric(gsub("[^0-9]", "", date_split[, 1]))
date_split_Error <- as.numeric(gsub("[^0-9]", "", date_split[, 2]))
# combine into data frame
dates_KM <- data.frame(Name = dates_KM$Name,
                       Date = date_split_Age,
                       Uncertainty = date_split_Error)
# SS
date_split  <- str_split_fixed(dates_SS$C14.date..BP..uncalibrated., "\\?\\?", 2)
date_split_Age <- as.numeric(gsub("[^0-9]", "", date_split[, 1]))
date_split_Error <- as.numeric(gsub("[^0-9]", "", date_split[, 2]))
# combine into data frame
dates_SS <- data.frame(Name = dates_SS$Name,
                       Date = date_split_Age,
                       Uncertainty = date_split_Error)

# combine all dates into one
dates <- rbind(dates_KM, dates_SS)
dates <- dates[complete.cases(dates), ]

# use the R package BChron...
library(Bchron)

# remove NAs
dates_SS <- dates_SS[complete.cases(dates_SS),]

# get estimation of activity through age as proxy

Dens_KM = BchronDensity(ages=dates_KM$Date, ageSds=dates_KM$Uncertainty, calCurves=rep('intcal13', nrow(dates_KM)))

Dens_SS = BchronDensity(ages=dates_SS$Date, ageSds=dates_SS$Uncertainty, calCurves=rep('intcal13', nrow(dates_SS)))

# get line for plotting

Dens_KM_plot <- BchronDensity_plot_params("KM", Dens_KM)
Dens_SS_plot <- BchronDensity_plot_params("SS", Dens_SS)

plot_all <- rbind(Dens_KM_plot, Dens_SS_plot)
```

```{r fig.height = 4, fig.width=8,}
library(ggplot2)
library(viridis)
ggplot(plot_all, aes(dateGrid, densFinal, colour = ID)) +
  geom_line(size = 0.5) +
  theme_minimal(base_size = 14) +
  xlab("calibrated years BP") +
  ylab("Density") +
  xlim(1000,4000) +
  scale_color_manual(values = viridis(length(unique(plot_all$ID))))
```



The chromatogram of the GC-MS analysis from one of our samples from the Sosa-Dong site (SOS049). Due to degradation, we usually observe medium- and long-chain saturated fatty acids. 5-Î± Cholestane was added as an internal standard (132 ng / microliter).   

```{r fig.height = 4, fig.width=8}
# Input data from csv file
SOS049 <-  read.csv(file="data/GC-MS_exported_data_Figure5a.csv", header=TRUE, sep=",")
make_retention_times_plot(SOS049)
```

The second chromatogram, sample KIM061

```{r fig.height = 4, fig.width=8}
# Input data from csv file
KIM061 <- read.csv(file="data/GC-MS_exported_data_Figure5b.csv", header=TRUE, sep=",") 
make_retention_times_plot_no_labels(KIM061)
```

The results of CSIA by GC-C-IRMS of the samples from the Sosa-Dong (SO) and Kimpo-Yangchon (KI) site using the reference from Craig et al., 2011 and Steele et al., 2010. 

```{r fig.height = 8, fig.width=8}
# read in data
CSIA_KM <- read.csv('data/CSIA_KM.csv', stringsAsFactors = FALSE)
CSIA_SS <- read.csv('data/CSIA_SS.csv', stringsAsFactors = FALSE)
# combine both into one dataframe
CSIA_KM_and_SS <- rbind(CSIA_KM, CSIA_SS)
# get site ID to control plotting colour and shape
CSIA_KM_and_SS$ID <- substr(CSIA_KM_and_SS$Sample.No., 1, 2)
# draw plot
make_C16_C18_scatter_plot(CSIA_KM_and_SS)
```


The big delta plot

```{r fig.height = 8, fig.width=8}
 big_delta <- d18 - d16
big_delta <- CSIA_KM_and_SS$C18.0 - CSIA_KM_and_SS$C16.0
big_delta <- data.frame(big_delta = big_delta, 
                        C16.0 = CSIA_KM_and_SS$C16.0, 
                        Site = CSIA_KM_and_SS$ID)
# plot
ggplot(big_delta, aes(C16.0, big_delta, colour = Site)) +
  geom_point(size = 4) +
  xlim(-40,-10) +
  theme_minimal(base_size = 14) +
  scale_y_continuous(breaks=seq(-10, 5, 1)) +
  scale_color_manual(values = viridis(length(unique(big_delta$Site))))
  
  
```



Here are the details of the computational environment that our analysis was conducted in:

```{r}
sessionInfo()
```
